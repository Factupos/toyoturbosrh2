<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Boletas de Rifa — rápido & fluido</title>
  <!-- ✅ Favicon dinámico (se reemplaza al cargar el logo desde Sheets) -->
  <link id="dynamicFavicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%0A%3Cdefs%3E%0A%3ClinearGradient%20id%3D%27g%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%0A%3Cstop%20offset%3D%270%27%20stop-color%3D%27%2300D46A%27/%3E%3Cstop%20offset%3D%270.33%27%20stop-color%3D%27%230B5CFF%27/%3E%3Cstop%20offset%3D%270.66%27%20stop-color%3D%27%23FFC400%27/%3E%3Cstop%20offset%3D%271%27%20stop-color%3D%27%23FF2E2E%27/%3E%0A%3C/linearGradient%3E%0A%3C/defs%3E%0A%3Crect%20width%3D%2764%27%20height%3D%2764%27%20rx%3D%2714%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Ccircle%20cx%3D%2732%27%20cy%3D%2734%27%20r%3D%2716%27%20fill%3D%27rgba%280%2C0%2C0%2C.25%29%27/%3E%0A%3Cpath%20d%3D%27M22%2038c4%206%2016%206%2020%200%27%20stroke%3D%27%23fff%27%20stroke-width%3D%274%27%20fill%3D%27none%27%20stroke-linecap%3D%27round%27/%3E%0A%3C/svg%3E">
  <link id="dynamicFaviconShortcut" rel="shortcut icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%0A%3Cdefs%3E%0A%3ClinearGradient%20id%3D%27g%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%0A%3Cstop%20offset%3D%270%27%20stop-color%3D%27%2300D46A%27/%3E%3Cstop%20offset%3D%270.33%27%20stop-color%3D%27%230B5CFF%27/%3E%3Cstop%20offset%3D%270.66%27%20stop-color%3D%27%23FFC400%27/%3E%3Cstop%20offset%3D%271%27%20stop-color%3D%27%23FF2E2E%27/%3E%0A%3C/linearGradient%3E%0A%3C/defs%3E%0A%3Crect%20width%3D%2764%27%20height%3D%2764%27%20rx%3D%2714%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Ccircle%20cx%3D%2732%27%20cy%3D%2734%27%20r%3D%2716%27%20fill%3D%27rgba%280%2C0%2C0%2C.25%29%27/%3E%0A%3Cpath%20d%3D%27M22%2038c4%206%2016%206%2020%200%27%20stroke%3D%27%23fff%27%20stroke-width%3D%274%27%20fill%3D%27none%27%20stroke-linecap%3D%27round%27/%3E%0A%3C/svg%3E">
  <link id="dynamicAppleTouch" rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%0A%3Cdefs%3E%0A%3ClinearGradient%20id%3D%27g%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%0A%3Cstop%20offset%3D%270%27%20stop-color%3D%27%2300D46A%27/%3E%3Cstop%20offset%3D%270.33%27%20stop-color%3D%27%230B5CFF%27/%3E%3Cstop%20offset%3D%270.66%27%20stop-color%3D%27%23FFC400%27/%3E%3Cstop%20offset%3D%271%27%20stop-color%3D%27%23FF2E2E%27/%3E%0A%3C/linearGradient%3E%0A%3C/defs%3E%0A%3Crect%20width%3D%2764%27%20height%3D%2764%27%20rx%3D%2714%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Ccircle%20cx%3D%2732%27%20cy%3D%2734%27%20r%3D%2716%27%20fill%3D%27rgba%280%2C0%2C0%2C.25%29%27/%3E%0A%3Cpath%20d%3D%27M22%2038c4%206%2016%206%2020%200%27%20stroke%3D%27%23fff%27%20stroke-width%3D%274%27%20fill%3D%27none%27%20stroke-linecap%3D%27round%27/%3E%0A%3C/svg%3E">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, interactive-widget=overlays-content">
  <!-- Performance -->
  <link rel="preconnect" href="https://docs.google.com" crossorigin>
  <link rel="preconnect" href="https://csv-proxy.jeisendigital.workers.dev" crossorigin>

  <style>
/* ====== BASE UI (ligero y veloz) ====== */
:root{
  /* ====== THEME (paleta del logo: Verde • Azul • Amarillo • Rojo) ====== */
  --brand-green:#00D46A;
  --brand-blue:#0B5CFF;
  --brand-yellow:#FFC400;
  --brand-red:#FF2E2E;

  /* Compatibilidad con el tema existente (3 acentos principales) */
  --brand-1:var(--brand-green);   /* principal */
  --brand-2:var(--brand-blue);    /* secundario */
  --brand-3:var(--brand-yellow);  /* tercer color */

  /* Fondo y paneles (alegre + premium, pero legible) */
  --bg-solid:#07152A;
  --bg-grad:
    radial-gradient(1200px 820px at 12% 10%, rgba(0,212,106,.28) 0, transparent 58%),
    radial-gradient(1100px 760px at 86% 18%, rgba(11,92,255,.26) 0, transparent 60%),
    radial-gradient(980px 680px at 24% 90%, rgba(255,196,0,.22) 0, transparent 62%),
    radial-gradient(900px 640px at 92% 92%, rgba(255,46,46,.14) 0, transparent 64%),
    linear-gradient(135deg, rgba(255,255,255,.07) 0%, rgba(255,255,255,.02) 35%, rgba(255,255,255,.06) 100%),
    linear-gradient(135deg, #07152A 0%, #0B2B66 45%, #0A0F1F 100%);

  --bg-deep:rgba(7,21,42,.78);  /* header */
  --ink:#ffffff;
  --muted:rgba(255,255,255,.86);

  --accent1:var(--brand-blue);
  --accent2:var(--brand-yellow);
  --accent3:var(--brand-green);
  --accent4:var(--brand-red);

  --panel:rgba(255,255,255,.13);
  --panel-strong:rgba(255,255,255,.17);
  --panel-border:rgba(255,255,255,.22);
  --shadow:rgba(0,0,0,.35);

  --header-h:90px; --vv-top:0px; --extra-top:0px;
  --sat: env(safe-area-inset-top, 0px);
}


/* ====== FONDO FLUIDO (sin cortes en páginas largas) ====== */
html, body{min-height:100%; background:#07152A;}
body{position:relative;}
/* Capa principal fija: no se repite ni “se corta” al crecer el contenido */
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-3;
  background:var(--bg-grad);
  background-repeat:no-repeat;
  background-attachment:fixed;
  background-size:cover;
}
/* Textura suave para fusionar transiciones y evitar líneas bruscas */
body::after{
  content:"";
  position:fixed;
  inset:-20%;
  z-index:-2;
  pointer-events:none;
  background:
    radial-gradient(800px 600px at 20% 15%, rgba(255,255,255,.05), transparent 60%),
    radial-gradient(900px 700px at 85% 20%, rgba(255,255,255,.04), transparent 62%),
    radial-gradient(1000px 800px at 25% 90%, rgba(255,255,255,.035), transparent 64%),
    radial-gradient(1100px 850px at 92% 88%, rgba(255,255,255,.03), transparent 66%);
  filter:blur(0.4px);
  opacity:.85;
  mix-blend-mode:soft-light;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%} html{overflow-anchor:none}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink); background:transparent;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  line-height:1.2;
  padding-top:calc(var(--header-h) + var(--sat) + var(--vv-top) + var(--extra-top));
  overscroll-behavior-y:contain; touch-action:manipulation;
}
.top-veil{
  position:fixed; left:0; right:0; top:0; z-index:25; pointer-events:none;
  height:calc(var(--header-h) + var(--sat) + var(--extra-top) + 16px);
  transform:translateY(var(--vv-top));
  background:linear-gradient(180deg, rgba(7,21,42,.88) 0%, rgba(7,21,42,.72) 42%, rgba(7,21,42,.44) 72%, rgba(7,21,42,0) 100%);
  -webkit-backdrop-filter:none; backdrop-filter:none;
  border-bottom:none;
  will-change:transform;
}
header{
  position:fixed; left:0; right:0; z-index:30; top:calc(var(--sat) + var(--vv-top) + var(--extra-top)) !important;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  padding:10px 14px; min-height:90px;
  background:linear-gradient(0deg,rgba(255,255,255,.08),rgba(255,255,255,.06)), var(--bg-deep);
  border-bottom:none;
  box-shadow:0 10px 26px rgba(0,0,0,.35);
  transform:translateZ(0); -webkit-transform:translateZ(0); backface-visibility:hidden; contain:paint;
}
.brand{display:flex;align-items:center;gap:12px}
.logoWrap{
  position:relative;
  width:56px; height:56px;
  border-radius:18px;
  flex:0 0 auto;
}
.logoWrap::before{
  content:"";
  position:absolute;
  inset:-5px;
  border-radius:24px;
  padding:6px;
  background:conic-gradient(from 180deg at 50% 50%, var(--accent1), var(--accent2), var(--accent3), var(--accent1));
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  opacity:.95;
  filter:drop-shadow(0 0 14px rgba(0,212,106,.25)) drop-shadow(0 0 10px rgba(11,92,255,.22));
  animation:logoRing 4.2s linear infinite;
  pointer-events:none;
}
.logoWrap::after{
  content:"";
  position:absolute;
  inset:-10px;
  border-radius:28px;
  background:radial-gradient(circle at 50% 40%, rgba(255,255,255,.14), rgba(0,212,106,.10), transparent 62%);
  filter:blur(10px);
  opacity:.55;
  animation:logoGlow 1.8s ease-in-out infinite alternate;
  pointer-events:none;
}
.logoWrap img{
  width:100%; height:100%;
  object-fit:cover;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.18);
  box-shadow:
    0 0 0 2px rgba(255,255,255,.14),
    0 0 0 6px rgba(255,255,255,.05),
    0 0 22px rgba(0,212,106,.30),
    0 0 22px rgba(11,92,255,.24);
  animation:logoPulse 1.6s ease-in-out infinite alternate;
}
@keyframes logoPulse{
  from{ transform:translateY(0) scale(1); filter:saturate(1.06) }
  to{ transform:translateY(-1px) scale(1.035); filter:saturate(1.22) brightness(1.05) }
}
@keyframes logoRing{to{transform:rotate(1turn)}}
@keyframes logoGlow{
  from{ transform:translateY(0); opacity:.55 }
  to{ transform:translateY(-1px); opacity:.85 }
}

/* ✅ NOMBRE EMPRESA (más pro, blanco + fuga azul eléctrico) */
.brand h1{
  margin:0;
  display:inline-block;
  position:relative;
  font-weight:1000;
  font-size:clamp(22px,3.8vw,30px);
  letter-spacing:.9px;
  line-height:1.05;
  color:#ffffff;
  text-transform:uppercase;
  text-shadow:
    0 2px 0 rgba(0,0,0,.22),
    0 0 16px rgba(11,92,255,.28),
    0 0 34px rgba(11,92,255,.18);
}
.brand h1::after{
  content:"";
  position:absolute;
  inset:-10px -18px;
  z-index:-1;
  background:
    radial-gradient(70% 90% at 8% 55%, rgba(11,92,255,.42) 0, rgba(11,92,255,.12) 45%, transparent 70%),
    radial-gradient(70% 90% at 95% 35%, rgba(255,255,255,.22) 0, rgba(11,92,255,.10) 46%, transparent 72%);
  filter:blur(10px);
  opacity:.75;
  transform:translate3d(0,0,0);
  pointer-events:none;
}

.search-bar{
  flex:1 1 320px;height:56px;border-radius:16px;border:1px solid var(--panel-border);
  padding:0 14px;font-size:20px;line-height:56px;outline:none;background:var(--panel);color:var(--ink);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.15),0 8px 20px rgba(0,0,0,.25);
  touch-action:manipulation;caret-color:#ffffff;-webkit-appearance:none;appearance:none;scroll-margin-top:14vh
}
.search-bar::placeholder{color:rgba(255,255,255,.78)}
.search-bar:focus{box-shadow:inset 0 0 0 2px var(--accent1),0 0 20px rgba(255,255,255,.16),0 0 24px rgba(11,92,255,.35)}
.random-button{
  height:56px;border-radius:16px;padding:0 16px;font-weight:900;letter-spacing:.5px;border:none;cursor:pointer;color:#07152A;background:linear-gradient(90deg,var(--accent3),var(--accent2),var(--accent1))
}
.contact-info{display:flex;flex-direction:row;align-items:center;gap:10px;margin-left:auto}
.contact-info p{margin:0;font-size:12px;color:#e5ffe8;font-weight:800;letter-spacing:.2px}

/* Botón FINALIZAR superior (solo carrito activo) */
.finish-top-button{
  height:40px; min-height:40px;
  border-radius:999px;
  padding:0 18px;
  font-size:12px; font-weight:900;
  letter-spacing:.5px;
  text-transform:uppercase;
  border:none; cursor:pointer;
  color:#062017;
  background:linear-gradient(90deg,var(--accent3),var(--accent1));
  box-shadow:0 0 0 1px rgba(255,255,255,.25),0 8px 20px rgba(0,0,0,.45);
  display:none;
  flex-shrink:0;
  align-items:center;
  justify-content:center;
  line-height:1;
}

/* Result: cuando hay seleccionado/aleatorio, solo se muestra el elegido */
.search-result{
  position:fixed; top:calc(var(--sat) + var(--vv-top) + var(--extra-top) + var(--header-h) + 12px);
  left:50%; transform:translateX(-50%); z-index:55;
  display:none; width:min(92vw,720px);
  pointer-events:auto; display:flex;flex-wrap:wrap;justify-content:center;gap:12px
}
body.search-has-text #raffles{ display:none !important; } /* << solo mostrar seleccionado */
#raffles{
  display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
  margin:16px auto 28px;max-width:1240px;padding:0 10px 20vh
}

/* ====== CARRITO DE BOLETAS (dentro del header, siempre estático) ====== */
.cart-panel{
  display:none;
  flex:0 0 100%;
  margin-top:6px;
  padding:6px 10px 4px;
  border-radius:14px;
  background:rgba(0,0,0,.2);
  border:1px solid rgba(255,255,255,.2);
  box-shadow:0 10px 26px rgba(0,0,0,.45);

  display:flex;
  align-items:flex-start;
  gap:8px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.cart-label{
  font-size:11px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.5px;
  padding-top:4px;
  color:var(--muted);
  white-space:nowrap;
}
.cart-strip{
  display:flex;
  gap:8px;
  flex:1;
  overflow-x:auto;
  padding:3px 0 4px;
  scroll-snap-type:x mandatory;
}
.cart-item{
  flex:0 0 auto;
  min-width:60px;
  padding:6px 9px;
  border-radius:999px;
  background:
    radial-gradient(circle at 0% 0%, rgba(255,255,255,.32) 0, transparent 40%),
    linear-gradient(120deg,var(--accent1),var(--accent2),var(--accent3));
  box-shadow:0 0 0 1px rgba(255,255,255,.35),0 0 16px rgba(0,0,0,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  position:relative;
  scroll-snap-align:start;
  animation:cartPulse 1.5s infinite alternate;
}
.cart-item::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius:inherit;
  border:1px solid rgba(255,255,255,.22);
  box-shadow:0 0 18px rgba(0,212,106,.8);
  opacity:.45;
  pointer-events:none;
}
.cart-item-num{
  font-size:18px;
  font-weight:900;
  text-shadow:0 0 10px rgba(0,0,0,.7);
}
.cart-item-remove{
  border:none;
  outline:none;
  cursor:pointer;
  width:20px;
  height:20px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  font-weight:900;
  background:rgba(0,0,0,.6);
  color:#ffffff;
  box-shadow:0 0 0 1px rgba(255,255,255,.35),0 0 10px rgba(0,0,0,.8);
  padding:0;
}
@keyframes cartPulse{
  0%{
    box-shadow:0 0 0 1px rgba(255,255,255,.3),0 0 10px rgba(0,212,106,.55);
    transform:translateY(0) scale(1);
  }
  50%{
    box-shadow:0 0 0 1px rgba(255,255,255,.4),0 0 18px rgba(11,92,255,.85);
    transform:translateY(-1px) scale(1.03);
  }
  100%{
    box-shadow:0 0 0 1px rgba(255,255,255,.28),0 0 22px rgba(255,196,0,.95);
    transform:translateY(0) scale(1);
  }
}

/* Tile */
.raffle{
  --size:clamp(92px,26vw,124px);
  width:var(--size);height:calc(var(--size) + 16px);
  border-radius:16px;display:flex;align-items:center;justify-content:center;
  position:relative;font-weight:900;color:#fff;
  background:
    radial-gradient(circle at 50% 28%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 37% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    radial-gradient(circle at 63% 42%, rgba(255,255,255,.10) 0 18%, transparent 19%),
    linear-gradient(145deg, transparent 0 62%, rgba(255,255,255,.10) 63%, transparent 64%),
    linear-gradient(160deg, rgba(255,255,255,.14), rgba(255,255,255,.06) 60%);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.10),0 10px 26px rgba(0,0,0,.35);
  outline:none;cursor:pointer;border:none;transform:translateZ(0)
}
.raffle .num{position:relative;z-index:2;font-size:clamp(38px,8.5vw,48px);line-height:1;text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 18px rgba(255,255,255,.18)}
.raffle::before{
  content:"";position:absolute;inset:-1px;border-radius:inherit;padding:6px;
  background:conic-gradient(from 180deg at 50% 50%,var(--accent1),var(--accent2),var(--accent3),var(--accent1));
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;opacity:.95
}
.raffle::after{content:"";position:absolute;inset:2px;border-radius:14px;background:radial-gradient(60% 60% at 50% 45%, rgba(255,255,255,.08), transparent 70%);z-index:0}
/* Estado SELECCIONADO (ya en carrito) */
.raffle .tick{
  position:absolute; top:10px; right:10px;
  width:26px; height:26px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:1000;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.22);
  box-shadow:0 0 0 1px rgba(255,255,255,.10), 0 10px 22px rgba(0,0,0,.35);
  opacity:0;
  transform:scale(.72);
  transition:opacity .18s ease, transform .18s ease;
  z-index:3;
  pointer-events:none;
}
.raffle.selected{
  transform:translateZ(0) scale(1.035);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.14),
    0 12px 30px rgba(0,0,0,.42),
    0 0 0 1px rgba(0,212,106,.18),
    0 0 26px rgba(0,212,106,.20),
    0 0 20px rgba(11,92,255,.14);
}
.raffle.selected::before{
  background:conic-gradient(from 180deg at 50% 50%, rgba(0,212,106,1), rgba(11,92,255,1), rgba(255,196,0,1), rgba(0,212,106,1));
  opacity:1;
  filter:drop-shadow(0 0 14px rgba(0,212,106,.35)) drop-shadow(0 0 10px rgba(11,92,255,.25));
}
.raffle.selected::after{
  background:radial-gradient(70% 70% at 50% 45%, rgba(0,212,106,.14), rgba(255,255,255,.08), transparent 72%);
}
.raffle.selected .tick{
  opacity:1;
  transform:scale(1);
  background:linear-gradient(135deg, rgba(0,212,106,.75), rgba(11,92,255,.55));
  color:#052015;
  border:1px solid rgba(255,255,255,.26);
  box-shadow:0 0 0 1px rgba(255,255,255,.18), 0 0 16px rgba(0,212,106,.25);
}
@keyframes selectedPulse{
  from{ filter:saturate(1.02) brightness(1.00); }
  to{ filter:saturate(1.20) brightness(1.05); }
}
.raffle.selected .num{ animation:selectedPulse 1.2s ease-in-out infinite alternate; }

.large-raffle{--size:clamp(160px,52vw,200px);width:var(--size);height:calc(var(--size) + 18px)}
.large-raffle .num{font-size:clamp(50px,12vw,70px)}

/* Mensajes y overlay */
/* Mensajes y overlay */
.message{
  padding:14px 16px;background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.45);
  border-radius:14px;width:min(92vw,420px);text-align:center;
  font-size:clamp(16px,4.8vw,22px);font-weight:900;display:none !important;
  position:fixed;top:calc(var(--sat) + var(--vv-top) + var(--extra-top) + var(--header-h) + 10px);left:50%;transform:translateX(-50%);
  z-index:60;box-shadow:0 12px 30px rgba(0,0,0,.35)
}

.message.error{background:#FF2E2E;border-color:#ffd0d0;color:#fff}
.loading-message{position:fixed;top:44%;left:50%;transform:translate(-50%,-50%);
  background:rgba(7,21,42,.55);color:rgba(255,255,255,.92);border:1px solid var(--panel-border);
  border-radius:14px;padding:16px 18px;text-align:center;font-size:clamp(18px,5vw,24px);
  display:none;box-shadow:0 12px 30px rgba(0,0,0,.35);z-index:40
}
.ov{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  backdrop-filter:saturate(120%) blur(2px);
  z-index:9000; display:none; align-items:center; justify-content:center
}
.ov.show{display:flex}
.box{display:block; min-width:min(92vw,520px); max-width:92vw;
  background:rgba(7,21,42,.58);color:#fff; border-radius:22px; border:1px solid var(--panel-border);
  box-shadow:0 20px 60px rgba(0,0,0,.55); padding:20px 18px; text-align:center; transform-origin:center center
}
.q{margin:0 0 10px 0;font-size:clamp(18px,5vw,22px);font-weight:900}
.actions{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin-top:6px;
}
.btn.ok{font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;background:linear-gradient(90deg,var(--accent1),#a9ffdf);color:#062017}
.btn.no{font-weight:900;border:none;border-radius:14px;padding:12px 18px;cursor:pointer;background:linear-gradient(90deg,#ff6b6b,#ffd0d0);color:#1a0606}

/* Revelado del número */
.raffle.revealed .num{animation:revealPop .6s cubic-bezier(.2,.9,.2,1)}
@keyframes revealPop{0%{transform:scale(.9);filter:brightness(1.25);text-shadow:0 0 18px rgba(255,255,255,.55),0 0 30px rgba(0,212,106,.28)}55%{transform:scale(1.05)}100%{transform:scale(1);filter:none}}

/* ====== BOOT / LOADING ULTRA PRO ====== */
.boot{
  position:fixed; inset:0;
  z-index:99999;
  display:none;
  align-items:center;
  justify-content:center;
  padding:22px 14px;
  color:rgba(255,255,255,.94);
  background:
    radial-gradient(1100px 760px at 12% 12%, rgba(255,46,46,.30) 0, transparent 60%),
    radial-gradient(1000px 720px at 86% 22%, rgba(11,92,255,.26) 0, transparent 62%),
    radial-gradient(900px 620px at 26% 86%, rgba(255,196,0,.22) 0, transparent 62%),
    linear-gradient(135deg, #07152A 0%, #0B2B66 38%, var(--accent4) 100%);
  overflow:hidden;
}
.boot.show{display:flex}
.boot::before{
  content:"";
  position:absolute; inset:-40%;
  background:
    conic-gradient(from 90deg, rgba(0,212,106,.25), rgba(11,92,255,.22), rgba(255,196,0,.20), rgba(0,212,106,.25));
  filter:blur(18px);
  animation:bootSpin 6.5s linear infinite;
  opacity:.55;
}
@keyframes bootSpin{to{transform:rotate(1turn)}}
.boot::after{
  content:"";
  position:absolute; inset:0;
  background:
    repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 2px, transparent 2px 10px);
  opacity:.10;
  mix-blend-mode:overlay;
  pointer-events:none;
}
.bootCard{
  position:relative;
  width:min(560px, 92vw);
  border-radius:24px;
  padding:18px 16px 16px;
  background:rgba(7,21,42,.52);
  border:1px solid rgba(255,255,255,.18);
  box-shadow:0 30px 90px rgba(0,0,0,.55);
  backdrop-filter:blur(10px) saturate(125%);
}
.bootTop{
  display:flex; align-items:center; gap:12px;
}
.bootLogo{
  width:54px; height:54px; border-radius:16px;
  background:
    radial-gradient(circle at 20% 20%, rgba(255,255,255,.35) 0, transparent 45%),
    linear-gradient(135deg, rgba(0,212,106,.9), rgba(11,92,255,.85), rgba(255,196,0,.8));
  box-shadow:0 0 0 2px rgba(255,255,255,.18), 0 0 26px rgba(0,212,106,.25);
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.bootLogo img{width:100%;height:100%;object-fit:cover;opacity:.92}
.bootTitle{
  margin:0;
  font-weight:1000;
  font-size:clamp(18px, 4.8vw, 22px);
  letter-spacing:.4px;
  line-height:1.1;
  background:linear-gradient(90deg,#fff,var(--accent2) 50%, var(--accent1));
  -webkit-background-clip:text;background-clip:text;color:transparent;
}
.bootSub{
  margin:3px 0 0 0;
  font-size:13px;
  opacity:.9;
  font-weight:700;
}
.bootMeter{
  margin-top:14px;
  height:14px;
  border-radius:999px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.12);
  overflow:hidden;
  position:relative;
}
.bootBar{
  height:100%;
  width:18%;
  border-radius:inherit;
  background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
  box-shadow:0 0 18px rgba(0,212,106,.35);
  transition:width .35s cubic-bezier(.2,1,.2,1);
}
.bootGlow{
  position:absolute; inset:-30%;
  background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.18) 0, transparent 55%);
  filter:blur(10px);
  animation:bootGlow 1.8s ease-in-out infinite alternate;
  opacity:.7;
}
@keyframes bootGlow{to{transform:translateX(10px) translateY(-6px);opacity:.95}}
.bootMsg{
  margin:12px 0 0;
  font-size:14px;
  font-weight:900;
  letter-spacing:.2px;
  display:flex;
  align-items:center;
  gap:10px;
}
.dotPulse{
  width:12px; height:12px; border-radius:999px;
  background:rgba(0,212,106,.95);
  box-shadow:0 0 16px rgba(0,212,106,.55), 0 0 26px rgba(11,92,255,.28);
  animation:dotPulse 1.1s ease-in-out infinite;
}
@keyframes dotPulse{
  0%{transform:scale(.82);opacity:.65}
  55%{transform:scale(1.12);opacity:1}
  100%{transform:scale(.86);opacity:.72}
}
.bootHint{
  margin:10px 0 0;
  font-size:12px;
  opacity:.85;
  font-weight:750;
  line-height:1.35;
}
.boot.hide{
  animation:bootOut .42s ease-in forwards;
}
@keyframes bootOut{
  to{opacity:0; transform:translateY(-6px); filter:blur(2px); pointer-events:none}
}

/* ====== BLOQUEADO (si Configuracion!X2 = TRUE) ====== */
.blocked{
  position:fixed; inset:0;
  z-index:99998;
  display:none;
  padding:20px 14px;
  align-items:center;
  justify-content:center;
  background:
    radial-gradient(900px 640px at 50% 10%, rgba(255,59,48,.20) 0, transparent 60%),
    radial-gradient(900px 640px at 20% 90%, rgba(255,196,0,.16) 0, transparent 62%),
    radial-gradient(1000px 720px at 80% 85%, rgba(11,92,255,.14) 0, transparent 65%),
    linear-gradient(135deg, #07152A 0%, #07152A 45%, #0A0F1F 100%);
}
.blocked.show{display:flex}
.blockCard{width:min(620px, 94vw);
  border-radius:26px;
  padding:18px 16px 16px;
  background:rgba(7,21,42,.52);
  border:1px solid rgba(255,255,255,.16);
  box-shadow:0 30px 90px rgba(0,0,0,.6);
  backdrop-filter:blur(10px) saturate(125%);
  text-align:center;
}
.blockBadge{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  border-radius:999px;
  background:rgba(255,59,48,.12);
  border:1px solid rgba(255,59,48,.30);
  box-shadow:0 0 26px rgba(255,59,48,.12);
  font-weight:1000;
  letter-spacing:.4px;
  text-transform:uppercase;
  font-size:12px;
}
.blockBadge i{
  display:inline-block;
  width:10px;height:10px;border-radius:999px;
  background:#FF2E2E;
  box-shadow:0 0 18px rgba(255,59,48,.55);
}
.blockTitle{
  margin:12px 0 6px;
  font-size:clamp(20px, 6vw, 28px);
  font-weight:1000;
  letter-spacing:.2px;
}
.blockText{
  margin:0 auto;
  max-width:520px;
  font-size:14px;
  opacity:.92;
  line-height:1.45;
  font-weight:750;
}
.blockMini{
  margin-top:12px;
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  opacity:.95;
  font-weight:850;
}
.miniChip{
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
}
.blockActions{
  margin-top:14px;
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}
.blockBtn{
  border:none;
  border-radius:16px;
  padding:12px 14px;
  cursor:pointer;
  font-weight:1000;
  letter-spacing:.3px;
  background:linear-gradient(90deg, var(--accent3), var(--accent1));
  color:#052015;
  box-shadow:0 0 0 1px rgba(255,255,255,.22), 0 10px 26px rgba(0,0,0,.5);
}
.blockBtn.secondary{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.20);
  color:#fff;
}

@media(max-width:768px){
  header{gap:8px;padding:12px 10px}
  .contact-info{flex-direction:row;flex-wrap:wrap;justify-content:center}
  .search-bar,.random-button{width:100%}
  #raffles{gap:10px;margin-top:12px}
}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation:none !important;transition:none !important}}
</style>

</head>

<body>
  <div class="top-veil" aria-hidden="true"></div>

  <!-- BOOT (pantalla de carga) -->
  <div id="boot" class="boot show" aria-live="polite" aria-busy="true">
    <div class="bootCard">
      <div class="bootTop">
        <div class="bootLogo" aria-hidden="true">
          <img id="bootLogoImg" src="" alt="" referrerpolicy="no-referrer">
        </div>
        <div>
          <p id="bootTitle" class="bootTitle">Cargando…</p>
          <p id="bootSub" class="bootSub">Preparando boletas y verificación de estado</p>
        </div>
      </div>
      <div class="bootMeter" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="10">
        <div id="bootBar" class="bootBar"></div>
        <div class="bootGlow" aria-hidden="true"></div>
      </div>
      <p class="bootMsg"><span class="dotPulse" aria-hidden="true"></span> <span id="bootMsgTxt">Iniciando…</span></p>
      <p class="bootHint" id="bootHint">Tip: en celular puedes escribir el número directo y se muestra solo la boleta.</p>
    </div>
  </div>

  <!-- BLOQUEADO (si Configuracion!X2 = TRUE) -->
  <div id="blocked" class="blocked" aria-live="polite">
    <div class="blockCard">
      <div class="blockBadge"><i></i> Sistema inhabilitado</div>
      <div class="blockTitle" id="blockedTitle">Esta página está temporalmente inhabilitada</div>
      <p class="blockText" id="blockedText">
        En este momento el acceso está restringido. Por favor intenta más tarde o contacta al administrador.
      </p>
      <div class="blockMini">
        <div class="miniChip" id="blockedName">Rifas</div>
        <div class="miniChip" id="blockedPhone"></div>
        <div class="miniChip" id="blockedAddr"></div>
      </div>
      <div class="blockActions">
        <button class="blockBtn" id="blockedWhatsApp" type="button">Contactar por WhatsApp</button>
        <button class="blockBtn secondary" id="blockedRetry" type="button">Reintentar</button>
      </div>
    </div>
  </div>

  <header>
    <div class="brand">
      <div class="logoWrap"><img id="logoImg" src="" alt="Logo" referrerpolicy="no-referrer"></div>
      <h1 id="houseName">Rifas</h1>
    </div>
    <input id="search" class="search-bar" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" enterkeyhint="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Buscar # de boleta…">
    <button class="random-button" id="randomButton"># ALEATORIO</button>
    <div class="contact-info"><p id="phone"></p><p id="address"></p></div>
    <!-- Botón Finalizar (carrito activo) -->
    <button id="finishTop" class="finish-top-button" type="button">Finalizar</button>
    <!-- Carrito -->
    <div id="cartPanel" class="cart-panel" aria-live="polite"></div>
  </header>

  <div id="searchResult" class="search-result"></div>
  <div id="raffles" aria-live="polite"></div>

  <!-- Overlay + Modal -->
  <div id="ov" class="ov" aria-hidden="true">
    <div id="box" class="box" role="dialog" aria-modal="true">
      <p id="q" class="q"></p>
      <div class="actions">
        <button id="yes" class="btn ok" type="button">Sí</button>
        <button id="keep" class="btn ok" type="button">Seguir separando</button>
        <button id="no" class="btn no" type="button">No</button>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div id="message" class="message">Boleta ocupada</div>
  <div id="loadingMessage" class="loading-message">Buscando número aleatorio...</div>

  <script>
/* =========================================================
   ✅ CONFIG (VISIBLES AL INICIO — como pediste)
   ========================================================= */
const KEY = '1VwAop3qmiZJwNWZsSRodQv6MfgZ6YoRc4OwhUzkH8YY';
const GID_RAFFLES = '1894872993';   // A: Número, B: Libre/Asignado
const GID_CONFIG  = '250403885';    // Config_Publica
const GID_NOTIFICATIONS = '1621926223'; // Notificaciones (logo)
const PROXY = 'https://csv-proxy.jeisendigital.workers.dev/?u=';

/* =========================================================
   ✅ LECTURAS ESPECIALES
   - Bloqueo: Configuracion!X2  (TRUE/FALSE)
   - Logo: Notificaciones!D2 (por defecto)
   ========================================================= */
const BLOCK_SHEET_NAME = 'Configuracion';
const WA_SHEET_NAME = 'Configuracion';
const WA_CELL_RANGE  = 'L2:L2';   // ✅ ÚNICO WhatsApp permitido (Configuracion!L2)

const BLOCK_CELL_RANGE = 'X2:X2';
const LOGO_CELL_RANGE  = 'D2:D2';   // ← si tu logo está en otra fila, cambia aquí (ej: D3:D3)

/* =========================
   RENDIMIENTO: caché local (AISLADO por página/hoja)
   ========================= */
const CACHE_TTL_MS = 10 * 60 * 1000; // 10 min

// Namespace único por página + spreadsheet + gids (evita mezclar caché entre páginas)
const CACHE_NS = (() => {
  const base = `${location.origin}${location.pathname}|${KEY}|${GID_RAFFLES}|${GID_CONFIG}|${GID_NOTIFICATIONS}`;
  let h = 2166136261; // FNV-1a
  for (let i = 0; i < base.length; i++) {
    h ^= base.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return `raffle_${(h >>> 0).toString(16)}`;
})();

// Metadatos para validar que un caché corresponde a esta misma página/hoja
const CACHE_META = Object.freeze({
  KEY,
  GID_RAFFLES,
  GID_CONFIG,
  GID_NOTIFICATIONS,
  path: location.pathname
});

const MAP_CACHE_KEY   = `${CACHE_NS}_map_v3`;
const CONF_CACHE_KEY  = `${CACHE_NS}_conf_v1`;
const LOGO_CACHE_KEY  = `${CACHE_NS}_logo_v1`;
const BLOCK_CACHE_KEY = `${CACHE_NS}_block_v1`;

// Daily también debe ser por página (no solo por fecha)
function dailyKey(){ return `${CACHE_NS}_daily_${todayKey()}`; }

function cacheMetaOK(meta){
  return !!meta && meta.KEY===KEY && meta.GID_RAFFLES===GID_RAFFLES && meta.GID_CONFIG===GID_CONFIG && meta.GID_NOTIFICATIONS===GID_NOTIFICATIONS && meta.path===location.pathname;
}


function saveMapCache(freeList){
  try{
    localStorage.setItem(
      MAP_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), meta: CACHE_META, freeList })
    );
  }catch(_){}
}
function loadMapCache(){
  try{
    const raw = localStorage.getItem(MAP_CACHE_KEY);
    if(!raw) return null;

    const { ts, meta, freeList } = JSON.parse(raw);
    if(!cacheMetaOK(meta)) return null;
    if(!Array.isArray(freeList)) return null;

    if(Date.now() - ts > CACHE_TTL_MS) return { freeList, stale: true };
    return { freeList, stale: false };
  }catch(_){
    return null;
  }
}
function saveConfCache(conf){
  try{
    localStorage.setItem(
      CONF_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), meta: CACHE_META, conf })
    );
  }catch(_){}
}
function loadConfCache(){
  try{
    const raw = localStorage.getItem(CONF_CACHE_KEY);
    if(!raw) return null;

    const { ts, meta, conf } = JSON.parse(raw);
    if(!cacheMetaOK(meta)) return null;
    if(!conf) return null;

    return { conf, stale: (Date.now() - ts) > CACHE_TTL_MS };
  }catch(_){
    return null;
  }
}
function saveLogoCache(logo){
  try{
    localStorage.setItem(
      LOGO_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), meta: CACHE_META, logo })
    );
  }catch(_){}
}
function loadLogoCache(){
  try{
    const raw = localStorage.getItem(LOGO_CACHE_KEY);
    if(!raw) return null;

    const { ts, meta, logo } = JSON.parse(raw);
    if(!cacheMetaOK(meta)) return null;
    if(!logo) return null;

    return { logo, stale: (Date.now() - ts) > CACHE_TTL_MS };
  }catch(_){
    return null;
  }
}
function saveBlockCache(isBlocked){
  try{
    localStorage.setItem(
      BLOCK_CACHE_KEY,
      JSON.stringify({ ts: Date.now(), meta: CACHE_META, isBlocked: !!isBlocked })
    );
  }catch(_){}
}
function loadBlockCache(){
  try{
    const raw = localStorage.getItem(BLOCK_CACHE_KEY);
    if(!raw) return null;

    const { ts, meta, isBlocked } = JSON.parse(raw);
    if(!cacheMetaOK(meta)) return null;
    if(typeof isBlocked !== 'boolean') return null;

    return { isBlocked, stale: (Date.now() - ts) > (2 * 60 * 1000) }; // 2 min
  }catch(_){
    return null;
  }
}

/* =========================
   BOOT UI (loading pro)
   ========================= */
function bootSet(pct, msg, sub){
  const boot = document.getElementById('boot');
  const bar = document.getElementById('bootBar');
  const m = document.getElementById('bootMsgTxt');
  const s = document.getElementById('bootSub');
  const title = document.getElementById('bootTitle');
  if(!boot || !bar || !m) return;
  const clamped = Math.max(2, Math.min(100, Math.round(pct||0)));
  bar.style.width = clamped + '%';
  boot.querySelector('.bootMeter')?.setAttribute('aria-valuenow', String(clamped));
  if(title && clamped >= 90) title.textContent = '¡Listo!';
  if(msg) m.textContent = msg;
  if(sub && s) s.textContent = sub;
}
function bootHide(){
  const boot = document.getElementById('boot');
  if(!boot) return;
  boot.classList.add('hide');
  setTimeout(()=>{ boot.classList.remove('show'); boot.setAttribute('aria-busy','false'); }, 450);
}
function bootShow(){
  const boot = document.getElementById('boot');
  if(!boot) return;
  boot.classList.add('show');
  boot.classList.remove('hide');
  boot.setAttribute('aria-busy','true');
}
function showBlockedScreen(reasonText){
  // Oculta boot y muestra bloqueado (sin cargar app)
  const boot = document.getElementById('boot');
  if(boot) boot.classList.remove('show');

  const blk = document.getElementById('blocked');
  if(!blk) return;
  blk.classList.add('show');

  // Completar info si existe config
  const n = (window.__CONFIG_NAME || 'Rifas').trim();
  const pr = (window.__CONFIG_PHONE || '').trim();
  const ad = (window.__CONFIG_ADDR || '').trim();

  const bn = document.getElementById('blockedName');
  const bp = document.getElementById('blockedPhone');
  const ba = document.getElementById('blockedAddr');
  if(bn) bn.textContent = n || 'Rifas';
  if(bp) bp.textContent = pr ? ('Tel: ' + pr) : 'Tel: —';
  if(ba) ba.textContent = ad ? ('Dir: ' + ad) : 'Dir: —';

  const bt = document.getElementById('blockedText');
  if(bt) bt.textContent = reasonText || 'En este momento el acceso está restringido.';

  // WhatsApp
  const btnWA = document.getElementById('blockedWhatsApp');
  if(btnWA){
    // Si no hay WhatsApp validado, no permitir abrir enlace
    const telReady = (window.__WHATSAPP_DIGITS || window.__CONFIG_PHONE_DIGITS || '').trim();
    if(!telReady){
      btnWA.disabled = true;
      btnWA.style.opacity = '0.6';
      btnWA.style.cursor = 'not-allowed';
      btnWA.textContent = 'WhatsApp no configurado';
    }
    btnWA.onclick = ()=>{
      try{
        const tel = window.__WHATSAPP_DIGITS || window.__CONFIG_PHONE_DIGITS || '';
        const msg = 'Hola, intento ingresar pero la página está inhabilitada. ¿Me puedes ayudar?';
        if(!tel) return; const url = 'https://wa.me/' + tel + '?text=' + encodeURIComponent(msg);
        const w = window.open(url, '_blank');
        if(!w) location.href = url;
      }catch(_){}
    };
  }

  // Reintentar (recarga)
  const retry = document.getElementById('blockedRetry');
  if(retry){
    retry.onclick = ()=> location.reload();
  }
}

/* =========================
   FETCH optimizado (parallel + timeout)
   ========================= */
const csvUrls = (gid) => {
  const ts = Date.now();
  return [
    `https://docs.google.com/spreadsheets/d/${KEY}/export?format=csv&gid=${gid}&_=${ts}`,
    `https://docs.google.com/spreadsheets/d/${KEY}/gviz/tq?tqx=out:csv&gid=${gid}&_=${ts}`
  ];
};
function fetchWithTimeout(url, timeout=6000){
  const ctrl = new AbortController();
  const to = setTimeout(()=>ctrl.abort(), timeout);
  return fetch(PROXY + encodeURIComponent(url), {signal:ctrl.signal, cache:'no-store', credentials:'omit'})
    .then(r=>{clearTimeout(to); if(!r.ok) throw new Error('HTTP '+r.status); return r.text()});
}
async function fetchCsvAny(gid, timeoutEach=6000){
  const urls = csvUrls(gid);
  const attempts = urls.map(u => fetchWithTimeout(u, timeoutEach).then(txt=>{
    if(txt && !txt.trimStart().startsWith('<')) return txt;
    throw new Error('Respuesta inválida');
  }));
  return new Promise((resolve, reject)=>{
    let rej=0, reason=null;
    attempts.forEach(p => p.then(resolve).catch(e=>{reason=e; if(++rej===attempts.length) reject(reason)}));
  });
}

/* Fetch por "sheet + range" (robusto, evita depender de gid para Configuracion) */
function rangeUrlsBySheet(sheetName, rangeA1){
  const ts = Date.now();
  const s = encodeURIComponent(sheetName);
  const r = encodeURIComponent(rangeA1);
  // gviz soporta sheet + range muy bien (ideal para celdas sueltas)
  return [
    `https://docs.google.com/spreadsheets/d/${KEY}/gviz/tq?tqx=out:csv&sheet=${s}&range=${r}&_=${ts}`,
    // fallback: a veces sheet+range funciona también en export
    `https://docs.google.com/spreadsheets/d/${KEY}/export?format=csv&sheet=${s}&range=${r}&_=${ts}`
  ];
}
async function fetchCsvBySheetRange(sheetName, rangeA1, timeoutEach=5500){
  const urls = rangeUrlsBySheet(sheetName, rangeA1);
  const attempts = urls.map(u => fetchWithTimeout(u, timeoutEach).then(txt=>{
    if(txt && !txt.trimStart().startsWith('<')) return txt;
    throw new Error('Respuesta inválida');
  }));
  return new Promise((resolve, reject)=>{
    let rej=0, reason=null;
    attempts.forEach(p => p.then(resolve).catch(e=>{reason=e; if(++rej===attempts.length) reject(reason)}));
  });
}

/* =========================
   Estado global liviano
   ========================= */
let ALL = {};             // { "0000": "libre"/"ocupado" }
let DAILY = [];           // hasta 240 render inmediato
let SEARCH_INPUT = null;
let GRID_TIMER = null;
let MAP_TIMER = null;
let MODAL_OPEN = false;
let DAY_MARK = null;

/* Carrito de compras */
let CART_ACTIVE = false;
let CART_ITEMS = [];

/* =========================
   Utils
   ========================= */
const pad4 = n => String(n).replace(/\D/g,'').slice(0,4).padStart(4,'0');
const todayKey = () => new Date().toISOString().slice(0,10);
function randInt(maxExclusive){
  if (crypto?.getRandomValues){ const b = new Uint32Array(1); crypto.getRandomValues(b); return b[0] % maxExclusive; }
  return Math.floor(Math.random()*maxExclusive);
}
function msg(text, error=false){
  const el = document.getElementById('message'); if(!el) return;
  el.textContent = text || ''; el.classList.toggle('error', !!error); el.style.display = 'block';
  clearTimeout(msg._t); msg._t = setTimeout(()=>{ el.style.display = 'none'; }, error ? 2000 : 1000);
}
function hideMsg(){ const el = document.getElementById('message'); if(!el) return; clearTimeout(msg._t); el.style.display='none'; }
function parseCSV(text){
  if (text.trimStart().startsWith('<')) return [];
  const rows=[]; let i=0,cur='',inQ=false; const push=()=>{ rows[rows.length-1].push(cur); cur='' };
  rows.push([]);
  while(i<text.length){
    const c=text[i];
    if(inQ){ if(c==='"'){ if(text[i+1]==='"'){cur+='"';i++} else inQ=false } else cur+=c; }
    else{ if(c==='"'){ inQ=true } else if(c===','){ push() } else if(c==='\n'){ push(); rows.push([]) } else if(c!=='\r'){ cur+=c } }
    i++;
  }
  push(); return rows.filter(r => r.some(x=>String(x).trim()!=='')); 
}
function makeBaseMap(){ const map={}; for(let i=0;i<10000;i++){ map[String(i).padStart(4,'0')]='ocupado' } return map }
function normStatusAB(s){ const t=String(s??'').trim().toLowerCase(); return t==='libre' ? 'libre' : 'ocupado' }
function extractColombiaDigits(raw){
  const chunks=(String(raw||'').match(/\d+/g)||[]); let d=chunks.join(''); d=d.replace(/^00/,'');
  const m=d.match(/57(3\d{9})/); if(m) return '57'+m[1];
  const m2=d.match(/(?:^|[^0-9])(3\d{9})(?:[^0-9]|$)/); if(m2) return '57'+m2[1];
  const m3=d.match(/0(3\d{9})/); if(m3) return '57'+m3[1];
  if(d.startsWith('57') && d.length>=12) return d.slice(0,12);
  return null;
}

/* =========================================================
   ✅ WHATSAPP ÚNICO (Config. interna: Configuracion!L2)
   - Elimina por completo cualquier número por defecto.
   - La app NO inicia si no logra leer/validar este número.
   ========================================================= */
function parseSingleCellFromCsv(text){
  const rows = parseCSV(text);
  return rows?.[1]?.[0] ?? rows?.[0]?.[0] ?? '';
}
function normalizeWhatsAppDigitsStrict(raw){
  const digits = extractColombiaDigits(raw);
  // En Colombia: '57' + 10 dígitos (celular 3xxxxxxxxx) => total 12
  if(!digits || !/^57\d{10}$/.test(digits)) return null;
  return digits;
}
async function loadWhatsAppDigitsStrict(){
  // ⚠️ Importante: NO usar caché como "seguridad". Se exige lectura real al abrir.
  const txt = await fetchCsvBySheetRange(WA_SHEET_NAME, WA_CELL_RANGE, 5500);
  const cell = parseSingleCellFromCsv(txt);
  const digits = normalizeWhatsAppDigitsStrict(cell);
  if(!digits){
    throw new Error('WhatsApp inválido en Configuracion!L2: ' + String(cell||'').trim());
  }
  // Único origen válido para WhatsApp en toda la página
  window.__WHATSAPP_DIGITS = digits;
  // Mantener compatibilidad con variables existentes en el código
  window.__CONFIG_PHONE_DIGITS = digits;
  return digits;
}


/* Recalcular altura del header cuando aparece/desaparece el carrito */
function recalcHeaderHeightDynamic(){
  const hEl = document.querySelector('header');
  if(!hEl) return;
  const h = Math.max(70, Math.round(hEl.getBoundingClientRect().height));
  document.documentElement.style.setProperty('--header-h', h + 'px');
}

/* =========================================================
   ✅ 1) CHEQUEO DE BLOQUEO (Configuracion!X2)
   ========================================================= */
function normalizeBoolCell(v){
  const t = String(v ?? '').trim().toUpperCase();
  if(t === 'TRUE') return true;
  if(t === 'FALSE') return false;
  // tolerancia por si llegan "Si/No" o "1/0"
  if(t === 'SI' || t === 'YES' || t === '1') return true;
  if(t === 'NO' || t === '0') return false;
  return null; // desconocido
}
async function getBlockedFlagFast(){
  // cache rápido (pero corto)
  const bc = loadBlockCache();
  if(bc && !bc.stale) return bc.isBlocked;

  try{
    const txt = await fetchCsvBySheetRange(BLOCK_SHEET_NAME, BLOCK_CELL_RANGE, 4500);
    const rows = parseCSV(txt);
    const cell = rows?.[1]?.[0] ?? rows?.[0]?.[0] ?? '';
    const val = normalizeBoolCell(cell);
    if(val === null) throw new Error('Valor bloqueo inválido: ' + cell);
    saveBlockCache(val);
    return val;
  }catch(_){
    // Si falla, usa cache viejo si hay; si no, asume NO bloqueado para no dejarte tirado
    if(bc) return bc.isBlocked;
    return false;
  }
}

/* =========================================================
   ✅ 2) LOGO DESDE Notificaciones!D2 (gid=1029797655)
   ========================================================= */

function setFaviconFromUrl(url){
  const u = String(url||'').trim();
  if(!u) return;

  const ids = ['dynamicFavicon','dynamicFaviconShortcut','dynamicAppleTouch'];
  for(const id of ids){
    let link = document.getElementById(id);
    if(!link){
      link = document.createElement('link');
      link.id = id;
      if(id==='dynamicAppleTouch'){ link.rel='apple-touch-icon'; }
      else if(id==='dynamicFaviconShortcut'){ link.rel='shortcut icon'; }
      else { link.rel='icon'; }
      document.head.appendChild(link);
    }
    link.href = u;

    // best-effort: ayuda a algunos navegadores a detectar el tipo
    if(id!=='dynamicAppleTouch'){
      const lower = u.toLowerCase();
      if(lower.endsWith('.png')) link.type = 'image/png';
      else if(lower.endsWith('.jpg')||lower.endsWith('.jpeg')) link.type = 'image/jpeg';
      else if(lower.endsWith('.svg')) link.type = 'image/svg+xml';
      else link.removeAttribute('type');
    }
  }

  // Algunos navegadores “cachean” el favicon; forzamos refresh cambiando href levemente
  const fav = document.getElementById('dynamicFavicon');
  if(fav){
    const bust = (u.includes('?') ? '&' : '?') + 'v=' + Date.now();
    fav.href = u + bust;
  }
}

function applyLogoUrl(url){
  const u = String(url||'').trim();
  if(!u) return;
  const img = document.getElementById('logoImg');
  const bimg = document.getElementById('bootLogoImg');
  if(img) img.src = u;
  if(bimg) bimg.src = u;
  setFaviconFromUrl(u);
}
async function loadLogoFast(){
  const cached = loadLogoCache();
  if(cached?.logo) applyLogoUrl(cached.logo);

  // Intento 1: leer celda suelta (sheet+range) por nombre (más portable)
  try{
    const txt = await fetchCsvBySheetRange('Notificaciones', LOGO_CELL_RANGE, 5000);
    const rows = parseCSV(txt);
    const cell = rows?.[1]?.[0] ?? rows?.[0]?.[0] ?? '';
    const u = String(cell||'').trim();
    if(u){
      applyLogoUrl(u);
      saveLogoCache(u);
      return;
    }
  }catch(_){}

  // Intento 2: fallback por gid completo y tomar D2 (por si "sheet" no está publicado)
  try{
    const txt = await fetchCsvAny(GID_NOTIFICATIONS, 5500);
    const rows = parseCSV(txt);
    // D2 = fila index 1, col index 3
    const cell = rows?.[1]?.[3] ?? '';
    const u = String(cell||'').trim();
    if(u){
      applyLogoUrl(u);
      saveLogoCache(u);
      return;
    }
  }catch(_){}
}

/* =========================
   UI helpers
   ========================= */
function closeBox(withScale){
  const ov=document.getElementById('ov'), box=document.getElementById('box');
  if(!ov||!box) return;
  const a1 = box.animate(withScale?[{transform:'scale(1)',opacity:1},{transform:'scale(.94)',opacity:0}]:[{opacity:1},{opacity:0}],{duration:180,easing:'ease-in',fill:'forwards'});
  const a2 = ov.animate([{backgroundColor:'rgba(0,0,0,0.35)'},{backgroundColor:'rgba(0,0,0,0)'}],{duration:180,fill:'forwards'});
  Promise.all([a1.finished,a2.finished]).catch(()=>{}).finally(()=>{
    MODAL_OPEN=false; ov.classList.remove('show'); ov.setAttribute('aria-hidden','true');
    box.style.opacity='1'; box.style.transform='none'; ov.style.backgroundColor='rgba(0,0,0,0.35)';
  });
}

/* Abrir WhatsApp */
function openWA(payload){
  const tel = window.__WHATSAPP_DIGITS || window.__CONFIG_PHONE_DIGITS || '';
  let message = '';

  if (Array.isArray(payload)) {
    const unique = Array.from(new Set(payload.map(pad4)));
    if (!unique.length) return;
    const listado = unique.map((n,idx)=> `${idx+1}. ${n}`).join('\n');
    message =
      `Hola, estoy interesado en separar los siguientes números:\n\n` +
      `${listado}\n\n` +
      `Total: ${unique.length} número${unique.length>1?'s':''}.\n\n` +
      `Quedo atento(a) a la confirmación de disponibilidad.`;
  } else {
    const number = pad4(payload);
    message = "Hola, estoy interesado en separar este número: " + number;
  }

  const url = "https://wa.me/" + tel + "?text=" + encodeURIComponent(message);
  const w = window.open(url, '_blank');
  if (!w){ location.href = url; }
}

/* Carrito */
function updateTopFinishVisibility(){
  const btn = document.getElementById('finishTop');
  if(!btn) return;
  if (CART_ACTIVE && CART_ITEMS.length){
    btn.style.display = 'inline-flex';
  } else {
    btn.style.display = 'none';
  }
}
function renderCart(){
  const panel = document.getElementById('cartPanel');
  if(!panel) return;
  panel.innerHTML = '';

  if(!CART_ITEMS.length){
    panel.style.display = 'none';
    recalcHeaderHeightDynamic();
    return;
  }

  panel.style.display = 'flex';

  const label = document.createElement('div');
  label.className = 'cart-label';
  label.textContent = 'Carrito (' + CART_ITEMS.length + ')';
  panel.appendChild(label);

  const strip = document.createElement('div');
  strip.className = 'cart-strip';
  panel.appendChild(strip);

  CART_ITEMS.slice().reverse().forEach(num=>{
  const item = document.createElement('div');
  item.className = 'cart-item';
  item.dataset.num = num;
  item.innerHTML =
    `<span class="cart-item-num">${num}</span>`+
    `<button type="button" class="cart-item-remove" aria-label="Quitar ${num}">&times;</button>`;
  strip.appendChild(item);
   });

  strip.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.cart-item-remove');
    if(!btn) return;
    const parent = btn.closest('.cart-item');
    const num = parent?.dataset.num;
    if(!num) return;
    removeFromCart(num);
  });

  recalcHeaderHeightDynamic();
}
function setTileSelected(num, selected){
  const p = pad4(num);
  // Números son 4 dígitos, así que el selector es seguro y ultra rápido
  document.querySelectorAll(`.raffle[data-num="${p}"]`).forEach(el=>{
    el.classList.toggle('selected', !!selected);
  });
}

function addToCart(n){
  const num = pad4(n);

  if (!CART_ITEMS.includes(num)){
    CART_ITEMS.push(num);
  }

  // ✅ Marcar visualmente en la grilla + en la búsqueda
  setTileSelected(num, true);

  if(!CART_ACTIVE){
    CART_ACTIVE = true;
    document.body.classList.add('cart-active');
  }
  renderCart();
  updateTopFinishVisibility();
}
function removeFromCart(num){
  const n = pad4(num);
  const idx = CART_ITEMS.indexOf(n);
  if(idx>-1){
    CART_ITEMS.splice(idx,1);
  }

  // ✅ Desmarcar visualmente
  setTileSelected(n, false);

  if(!CART_ITEMS.length){
    CART_ACTIVE = false;
    document.body.classList.remove('cart-active');
  }
  renderCart();
  updateTopFinishVisibility();
}
function finalizeCart(){
  if(!CART_ACTIVE || !CART_ITEMS.length){
    msg('No hay números en el carrito', true);
    return;
  }
  const unique = Array.from(new Set(CART_ITEMS.map(pad4)));

  // ✅ Limpia selección visual (por si vuelves a la página)
  unique.forEach(n => setTileSelected(n, false));

  openWA(unique);

  CART_ITEMS = [];
  CART_ACTIVE = false;
  document.body.classList.remove('cart-active');
  renderCart();
  updateTopFinishVisibility();
}

function makeTile(num, large){
  const el = document.createElement('div');
  const p = pad4(num);
  el.className = 'raffle' + (large ? ' large-raffle' : '');
  el.dataset.num = p;
  el.innerHTML = `<span class="num">${p}</span><span class="tick" aria-hidden="true">✓</span>`;
  if (CART_ITEMS.includes(p)) el.classList.add('selected');

  el.addEventListener('pointerdown', (ev)=>{ el._lastPt = {x:ev.clientX, y:ev.clientY}; }, {passive:true});
  el.addEventListener('touchstart', (ev)=>{ const t=ev.touches&&ev.touches[0]; if(t) el._lastPt={x:t.clientX,y:t.clientY}; }, {passive:true});
  el.addEventListener('click', (ev)=> onTileTap(el, p, el._lastPt || {x:ev.clientX, y:ev.clientY}), {passive:true});
  return el;
}
function renderGrid(){
  const wrap=document.getElementById('raffles'); if(!wrap) return;
  if(document.body.classList.contains('search-has-text') || MODAL_OPEN) return;
  wrap.innerHTML='';
  const frag = document.createDocumentFragment();
  for(const n of DAILY){ frag.appendChild(makeTile(n,false)); }
  wrap.appendChild(frag);
}
function renderSearchOne(num){
  const layer=document.getElementById('searchResult');
  layer.style.display='none'; layer.innerHTML=''; if(!num) return;
  const t=makeTile(num,true); layer.appendChild(t); layer.style.display='flex';
  requestAnimationFrame(()=> t.classList.add('revealed'));
}
function clearSearchLayer(){ const layer=document.getElementById('searchResult'); layer.style.display='none'; layer.innerHTML='' }

/* =========================
   Config pública (rápida con caché)
   ========================= */
async function loadConfigFast(){
  const cached = loadConfCache();
  if (cached?.conf){ applyConfig(cached.conf); }
  try{
    const txt = await fetchCsvAny(GID_CONFIG, 5000);
    const rows = parseCSV(txt);
    if(rows.length>=2){
      const conf = readConf(rows);
      applyConfig(conf);
      saveConfCache(conf);
    }
  }catch(_){ /* usar caché si existe */ }
}
function readConf(rows){
  const head=rows[0], data=rows[1];
  const hIdx=(name)=> head.findIndex(h => String(h).trim().toLowerCase()===name.toLowerCase());
  return {
    name: data[hIdx('Nombre_APP')] || data[hIdx('Nombre_De_La_Rifa')] || 'Rifas',
    phoneRaw: data[hIdx('Telefonos')] || '',
    address: data[hIdx('Direccion')] || '',
    logo: data[hIdx('Logo')] || ''
  };
}
function applyConfig({name,phoneRaw,address,logo}){
  document.getElementById('houseName').textContent = String(name||'').trim();
  document.getElementById('phone').textContent = phoneRaw ? ('Tel: ' + phoneRaw) : '';
  document.getElementById('address').textContent = address ? ('Dir: ' + address) : '';

  // guardamos para pantalla bloqueada
  window.__CONFIG_NAME = String(name||'').trim();
  window.__CONFIG_PHONE = String(phoneRaw||'').trim();
  window.__CONFIG_ADDR = String(address||'').trim();

  // logo base (solo fallback)
  const baseLogo = String(logo||'').trim();
  if(baseLogo){
    document.getElementById('logoImg').src = baseLogo;
    const b = document.getElementById('bootLogoImg'); if(b && !b.src) b.src = baseLogo;
  }

  /* WhatsApp se toma ÚNICAMENTE de Configuracion!L2 (ver loadWhatsAppDigitsStrict) */
  // window.__CONFIG_PHONE_DIGITS se define al validar Configuracion!L2

}

/* =========================
   Mapa rápido (caché primero)
   ========================= */
function setAllFromFreeList(freeList){
  const map = makeBaseMap();
  for(const n of freeList){ map[n] = 'libre'; }
  ALL = map;
}
function sampleDailyFromFreeList(freeList, target=240){
  const L = freeList.length;
  if(L<=target) return [...freeList];
  const out = freeList.slice(0, target);
  for(let i=target;i<L;i++){
    const j = randInt(i+1);
    if(j<target) out[j] = freeList[i];
  }
  return out;
}
function persistDaily(){
  const key = dailyKey();
  try{ localStorage.setItem(key, JSON.stringify(DAILY||[])) }catch(_){}
}
function loadDailyFromCache(){
  const key = dailyKey();
  try{
    const cached = JSON.parse(localStorage.getItem(key) || '[]');
    if(Array.isArray(cached) && cached.length){
      DAILY = cached.filter(n => ALL[n] === 'libre');
      persistDaily();
      return DAILY.length > 0;
    }
  }catch(_){}
  return false;
}
function pickDaily(force=false){
  if(!force && loadDailyFromCache()) return;
  const libres = Object.keys(ALL||{}).filter(k=>ALL[k]==='libre');
  DAILY = sampleDailyFromFreeList(libres, 240);
  persistDaily();
}

/* =========================
   Sincronización remota
   ========================= */
async function syncMapFast(){
  try{
    const txt = await fetchCsvAny(GID_RAFFLES, 6000);
    const rows = parseCSV(txt);
    if(rows.length < 2) return;
    const freeList=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]||[]; const a=(r[0]??'').toString().trim(); const b=(r[1]??'').toString().trim();
      if(!a) continue; let digits=a.replace(/\D/g,''); if(!digits) continue;
      if(digits.length>4) digits=digits.slice(0,4);
      const num=digits.padStart(4,'0');
      if (normStatusAB(b)==='libre') freeList.push(num);
    }
    saveMapCache(freeList);
    setAllFromFreeList(freeList);
    const before=DAILY.length;
    DAILY = DAILY.filter(n=>ALL[n]==='libre');
    if(DAILY.length===0){ pickDaily(true); }
    if(DAILY.length!==before){ renderGrid(); }
  }catch(_){ }
}

/* =========================
   Búsqueda
   ========================= */
async function rerenderSearch(){
  const layer=document.getElementById('searchResult'); hideMsg();
  const raw=(SEARCH_INPUT.value||'').replace(/\D/g,'').slice(0,4);
  if(SEARCH_INPUT.value!==raw) SEARCH_INPUT.value=raw;
  layer.style.display='none'; layer.innerHTML='';
  if(raw.length===0){ document.body.classList.remove('search-has-text'); return; }
  document.body.classList.add('search-has-text');
  const padded=pad4(raw); const st=ALL[padded]||'ocupado';
  if(st==='libre'){ hideMsg(); renderSearchOne(padded); } else { clearSearchLayer(); msg('Boleta ocupada', true); }
}

/* =========================
   EFECTOS (on-demand)
   ========================= */
function overlayCanvas(container){
  if(!container) return null;
  const cs=getComputedStyle(container);
  if(cs.position==='static') container.style.position='relative';
  const rect=container.getBoundingClientRect();
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const c=document.createElement('canvas'); const w=Math.max(1,Math.floor(rect.width*dpr)); const h=Math.max(1,Math.floor(rect.height*dpr));
  c.width=w; c.height=h; c.style.width=rect.width+'px'; c.style.height=rect.height+'px';
  c.style.position='absolute'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex='5';
  container.appendChild(c); const ctx=c.getContext('2d');
  return {c,ctx,dpr,w,h,cleanup:()=>c.remove()};
}
function fullscreenCanvas(parent){
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const c=document.createElement('canvas'); const w=Math.max(1,Math.floor(window.innerWidth*dpr)); const h=Math.max(1,Math.floor(window.innerHeight*dpr));
  c.width=w; c.height=h; c.style.width='100%'; c.style.height='100%';
  c.style.position='absolute'; c.style.inset='0'; c.style.pointerEvents='none'; c.style.zIndex='1';
  parent.appendChild(c); const ctx=c.getContext('2d');
  return {c,ctx,dpr,w,h,cleanup:()=>c.remove()};
}
function animateMs(duration, draw){
  return new Promise(res=>{
    const s=performance.now(); let last=s, id=0;
    function loop(t){ const e=t-s; const dt=Math.min(64,t-last)/1000; last=t; const p=Math.min(1,e/duration); draw(p,dt,e); if(e<duration){ id=requestAnimationFrame(loop) } else { cancelAnimationFrame(id); res(); } }
    id=requestAnimationFrame(loop);
  });
}
const easeOutCubic=x=>1-Math.pow(1-x,3);
const rgba=(r,g,b,a)=>`rgba(${r},${g},${b},${a})`;

function playWaterRipple(container, duration=1200, center){
  if(!container) return Promise.resolve();
  if(matchMedia('(prefers-reduced-motion: reduce)').matches) return Promise.resolve();
  const oc=overlayCanvas(container); if(!oc) return Promise.resolve();
  const {ctx,w,h,dpr,cleanup}=oc;
  const cx=center?.x ?? (w/2), cy=center?.y ?? (h/2);
  const sparkCols=[[255,212,77],[0,255,169]];
  const SPN=Math.floor(14*Math.min(1.5,(w*h)/60000));
  const sparks=[];
  for(let i=0;i<SPN;i++){
    const ang=Math.random()*Math.PI*2, sp=(120+Math.random()*160)*dpr;
    sparks.push({x:cx,y:cy,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp-70*dpr,r:(1+Math.random()*1.8)*dpr,life:0,max:0.5+Math.random()*0.45,col:sparkCols[(Math.random()*sparkCols.length)|0]});
  }
  const maxR=Math.hypot(w,h)*0.55; const rings=[{d:0},{d:110},{d:220}];
  function ring(R,th,a){
    if(R<=0||th<=0||a<=0)return;
    const inner=Math.max(0.0001,R-th), outer=R+th;
    const g=ctx.createRadialGradient(cx,cy,inner,cx,cy,outer);
    g.addColorStop(0.0,'rgba(0,0,0,0)');
    g.addColorStop(0.18,rgba(0,0,0,0.22*a));
    g.addColorStop(0.45,rgba(255,255,255,0.50*a));
    g.addColorStop(0.62,rgba(0,212,106,0.58*a));
    g.addColorStop(0.84,rgba(11,92,255,0.30*a));
    g.addColorStop(1.0,'rgba(0,0,0,0)');
    ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
    ctx.save(); ctx.lineWidth=Math.max(0.8,2.5*dpr*(1-R/maxR)); ctx.strokeStyle=rgba(255,255,255,0.3*a);
    const arcLen=Math.PI*0.5, rot=-Math.PI/6; ctx.beginPath(); ctx.arc(cx,cy,R,rot,rot+arcLen); ctx.stroke(); ctx.restore();
  }
  return animateMs(duration,(p,dt,ms)=>{
    ctx.clearRect(0,0,w,h);
    const dimA=0.22*easeOutCubic(Math.min(1,ms/180)); ctx.fillStyle=rgba(0,0,0,dimA); ctx.fillRect(0,0,w,h);
    for(const r of rings){
      const t=ms-r.d; if(t<0) continue;
      const pr=Math.min(1,t/(duration-r.d+1)); const amp=(1-pr)*0.95; const R=pr*maxR; const th=Math.max(1.2*dpr, 9*dpr*(1-pr));
      ring(R,th,amp);
    }
    ctx.globalCompositeOperation='lighter';
    for(const s of sparks){
      s.life+=dt; s.vx*=(1-0.55*dt); s.vy*=(1-0.55*dt); s.vy+=200*dt*dpr*0.25; s.x+=s.vx*dt; s.y+=s.vy*dt;
      const a=Math.max(0,1-(s.life/s.max)); if(a<=0) continue;
      ctx.beginPath(); ctx.fillStyle=rgba(s.col[0],s.col[1],s.col[2],0.9*a); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
      if(Math.random()<0.08){ ctx.beginPath(); ctx.fillStyle=rgba(255,255,255,0.55*a); ctx.arc(s.x,s.y,s.r*0.5,0,Math.PI*2); ctx.fill(); }
    }
    ctx.globalCompositeOperation='source-over';
  }).then(cleanup);
}
async function drawTrailFromTileToBox(tile, box, ov, duration=480){
  if(matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const fs=fullscreenCanvas(ov); if(!fs) return;
  const {ctx,dpr,cleanup}=fs;
  const tr=tile.getBoundingClientRect(), br=box.getBoundingClientRect();
  const sx=(tr.left+tr.width/2)*dpr, sy=(tr.top+tr.height/2)*dpr;
  const ex=(br.left+br.width/2)*dpr, ey=(br.top+br.height/2)*dpr;
  const ctrl={x:(sx+ex)/2, y:Math.min(sy,ey)-100*dpr};
  const sparks=[];
  function addSpark(px,py){ sparks.push({x:px,y:py,vx:(Math.random()-0.5)*100*dpr,vy:(Math.random()-0.8)*140*dpr,life:0,max:0.22+Math.random()*0.18,r:(0.7+Math.random()*1.4)*dpr,col: (Math.random()<0.5 ? [255,212,77] : [0,255,169])}); }
  await animateMs(duration,(p,dt)=>{
    const w=window.innerWidth*dpr, h=window.innerHeight*dpr;
    ctx.clearRect(0,0,w,h);
    const t=p;
    const x=(1-t)*(1-t)*sx + 2*(1-t)*t*ctrl.x + t*t*ex;
    const y=(1-t)*(1-t)*sy + 2*(1-t)*t*ctrl.y + t*t*ey;
    const base=Math.max(1.5*dpr, 8*dpr*(1-p));
    const grd=ctx.createLinearGradient(x,y,sx,sy);
    grd.addColorStop(0,'rgba(255,255,255,0.85)');
    grd.addColorStop(0.25,'rgba(255,212,77,0.7)');
    grd.addColorStop(1,'rgba(0,212,106,0.0)');
    ctx.save(); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.shadowBlur=16*dpr; ctx.shadowColor='rgba(255,212,77,0.5)';
    ctx.strokeStyle=grd; ctx.lineWidth=base; ctx.beginPath(); ctx.moveTo(sx,sy); ctx.quadraticCurveTo(ctrl.x,ctrl.y,x,y); ctx.stroke();
    ctx.shadowBlur=22*dpr; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.arc(x,y,base*0.36,0,Math.PI*2); ctx.fill();
    ctx.shadowColor='rgba(0,212,106,0.5)'; ctx.strokeStyle='rgba(0,212,106,0.4)'; ctx.lineWidth=base*0.5;
    ctx.beginPath(); ctx.moveTo(sx,sy); ctx.quadraticCurveTo(ctrl.x,ctrl.y,x,y); ctx.stroke(); ctx.restore();
    addSpark(x,y);
    ctx.globalCompositeOperation='lighter';
    for(let i=sparks.length-1;i>=0;i--){
      const s=sparks[i]; s.life+=dt; s.vx*=(1-0.5*dt); s.vy+=180*dt*dpr*0.3; s.x+=s.vx*dt; s.y+=s.vy*dt;
      const a=Math.max(0,1-s.life/s.max); if(a<=0){sparks.splice(i,1); continue;}
      ctx.beginPath(); ctx.fillStyle=rgba(s.col[0],s.col[1],s.col[2],0.9*a); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
    }
    ctx.globalCompositeOperation='source-over';
  });
  cleanup();
}
function showChoiceFromTile(tile, n){
  const ov=document.getElementById('ov'), box=document.getElementById('box');
  const yes=document.getElementById('yes'), no=document.getElementById('no'), q=document.getElementById('q');
  const keep=document.getElementById('keep');
  if(!ov||!box||!yes||!no||!q||!keep) return;

  MODAL_OPEN=true;

  if(!CART_ACTIVE){
    q.textContent = "¿Quieres separar este número? " + n;
    yes.style.display = 'inline-block';
    no.style.display = 'inline-block';
    keep.style.display = 'inline-block';
    yes.textContent = 'Sí';
    no.textContent = 'No';
    keep.textContent = 'Seguir separando';
  }else{
    q.textContent = "Has seleccionado el número " + n;
    keep.style.display = 'inline-block';
    yes.style.display = 'inline-block';
    no.style.display = 'none';
    keep.textContent = 'Seguir separando';
    yes.textContent = 'Finalizar';
  }

  ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
  box.style.opacity='0'; box.style.transform='translate(0,0) scale(1)'; box.style.willChange='transform,opacity';

  requestAnimationFrame(async ()=>{
    const tr=tile.getBoundingClientRect(), br=box.getBoundingClientRect();
    const tx=tr.left+tr.width/2, ty=tr.top+tr.height/2, bx=br.left+br.width/2, by=br.top+br.height/2;
    const dx=tx-bx, dy=ty-by;
    drawTrailFromTileToBox(tile,box,ov,480).catch(()=>{});
    ov.animate([{backgroundColor:'rgba(0,0,0,0)'},{backgroundColor:'rgba(0,0,0,0.35)'}],{duration:220,easing:'ease-out',fill:'forwards'});
    const kf=[{transform:`translate(${dx}px,${dy}px) scale(0.26)`,opacity:0},
              {transform:`translate(${dx*0.10}px,${dy*0.10}px) scale(1.06)`,opacity:1,offset:0.66},
              {transform:'translate(0,0) scale(1)',opacity:1}];
    const a=box.animate(kf,{duration:520,easing:'cubic-bezier(.2,1,.2,1)',fill:'forwards'});
    a.onfinish=()=>{box.style.opacity='1'; box.style.transform='none'; box.style.willChange='auto';};
  });

  yes.onclick = (e)=>{
    e.preventDefault(); e.stopPropagation();
    if(CART_ACTIVE){
      addToCart(n);
      closeBox(true);
      finalizeCart();
    }else{
      closeBox(true);
      openWA(n);
    }
  };
  no.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); closeBox(false); };
  keep.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); addToCart(n); closeBox(true); };
  ov.onclick = ()=> closeBox(false);
  box.onclick=(e)=> e.stopPropagation();
}
function onTileTap(el, num, pt){
  if(!el || el.dataset.busy==='1') return;

  const n = pad4(num);

  // Si el mapa dice que está ocupada, no permitimos agregar
  const st = ALL?.[n];
  if(st && st !== 'libre'){
    msg('Boleta ocupada', true);
    return;
  }

  // Ya estaba seleccionada
  if(CART_ITEMS.includes(n)){
    setTileSelected(n, true);
    msg('Ya está en el carrito: ' + n, false);
    return;
  }

  el.dataset.busy='1';
  hideMsg();

  const rect=el.getBoundingClientRect();
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const cx=((pt?.x ?? (rect.left+rect.width/2)) - rect.left)*dpr;
  const cy=((pt?.y ?? (rect.top+rect.height/2))  - rect.top )*dpr;

  // Efecto suave + rápido (no bloquea)
  playWaterRipple(el, 900, {x:cx,y:cy})
    .finally(()=>{ el.dataset.busy=''; });

  // ✅ Directo al carrito (sin ventana)
  addToCart(n);
  msg('Agregado al carrito: ' + n, false);
}

/* =========================
   INIT ultrarrápido + BLOQUEO
   ========================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  bootShow();
  bootSet(10, 'Iniciando…', 'Verificando estado y preparando interfaz');

  function updateHeaderPadding(){ recalcHeaderHeightDynamic(); }
  function applyViewportOffset(){
    let top = 0;

    if (window.visualViewport){
      const vv = window.visualViewport;

      // ✅ Solo aplicar offset cuando realmente parece teclado abierto.
      // En iOS Safari, offsetTop cambia durante el scroll normal por la barra del navegador.
      const keyboardLikely = (window.innerHeight - vv.height) > 120;

      if (keyboardLikely){
        top = Math.max(0, Math.round(vv.offsetTop || 0));
        // ✅ Clamp defensivo para evitar valores locos que crean “velos” gigantes/parpadeos
        top = Math.min(top, 180);
      } else {
        top = 0;
      }
    }

    document.documentElement.style.setProperty('--vv-top', top + 'px');
    updateHeaderPadding();
  }
  updateHeaderPadding(); applyViewportOffset();

  if (window.visualViewport){
    visualViewport.addEventListener('resize', ()=>requestAnimationFrame(applyViewportOffset));
    // ❌ NO escuchar visualViewport.scroll (glitch iOS)
  }
  window.addEventListener('resize', ()=>requestAnimationFrame(applyViewportOffset), { passive:true });

  // Carga base (config + logo) en paralelo para que boot se vea pro y rápido
  bootSet(18, 'Cargando configuración…', 'Aplicando nombre, teléfono, dirección y logo');
  await Promise.allSettled([
    loadConfigFast(),
    loadLogoFast()
  ]);

  // Título boot con el nombre (si ya está disponible)
  const bt = document.getElementById('bootTitle');
  if(bt) bt.textContent = (window.__CONFIG_NAME ? window.__CONFIG_NAME : 'Rifas');

  // ✅ Chequeo bloqueo lo primero (ya con datos básicos)
  bootSet(28, 'Verificando habilitación…', 'Leyendo Configuracion!X2');
  const isBlocked = await getBlockedFlagFast();
  if(isBlocked === true){
    showBlockedScreen('Acceso restringido por configuración (Configuracion!X2 = TRUE).');
    return; // ⛔ no continúa la app
  }

  // ✅ WHATSAPP ÚNICO (Config. interna)
  bootSet(34, 'Verificando WhatsApp…', 'Leyendo Configuracion!L2');
  try{
    await loadWhatsAppDigitsStrict();
  }catch(err){
    // No iniciar si no hay validación real del WhatsApp
    showBlockedScreen('No se pudo validar el número de WhatsApp (Configuracion!L2).\n\nRevisa que L2 tenga un celular válido (ej: 3XXXXXXXXX) y que la hoja sea accesible para lectura.');
    return;
  }

  // Inputs
  bootSet(40, 'Activando búsqueda…', 'Optimizando para celular');
  const SEARCH_INPUT_EL=document.getElementById('search'); SEARCH_INPUT=SEARCH_INPUT_EL;

  function instantFocus(e){
    if(document.activeElement!==SEARCH_INPUT){
      e.preventDefault(); SEARCH_INPUT.focus({preventScroll:true});
      setTimeout(()=>{ try{ const len=SEARCH_INPUT.value.length; SEARCH_INPUT.setSelectionRange(len,len);}catch(_){ }},0);
    }
  }
  SEARCH_INPUT.addEventListener('pointerdown',instantFocus,{passive:false});
  SEARCH_INPUT.addEventListener('touchstart',instantFocus,{passive:false});
  SEARCH_INPUT.addEventListener('click',()=>{ if(document.activeElement!==SEARCH_INPUT) SEARCH_INPUT.focus({preventScroll:true}); },{passive:true});
  SEARCH_INPUT.addEventListener('input',()=>{ rerenderSearch(); });
  SEARCH_INPUT.addEventListener('blur',()=>{ if(!MODAL_OPEN && SEARCH_INPUT.value.trim().length===0){ document.body.classList.remove('search-has-text'); clearSearchLayer(); } });

  // Botón ALEATORIO
  const randomBtn=document.getElementById('randomButton');
  randomBtn.addEventListener('click', async ()=>{
    if(randomBtn.dataset.busy==='1') return; randomBtn.dataset.busy='1';
    hideMsg();

    const layer=document.getElementById('searchResult');
    layer.style.display='none'; layer.innerHTML='';
    document.body.classList.add('search-has-text');

    if(!ALL || !Object.keys(ALL).length){
      const c=loadMapCache(); if(c?.freeList){ setAllFromFreeList(c.freeList); }
      else { await syncMapFast(); }
    }
    const libres=Object.keys(ALL||{}).filter(k=>ALL[k]==='libre');
    const chosen = libres.length ? libres[randInt(libres.length)] : String(randInt(10000)).padStart(4,'0');

    const placeholder=document.createElement('div'); placeholder.className='raffle large-raffle'; layer.appendChild(placeholder); layer.style.display='flex';

    await (async function playMagicBurst(container, duration=1000){
      if(!container || matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const oc=overlayCanvas(container); if(!oc) return;
      const {ctx,w,h,dpr,cleanup}=oc; const cx=w/2, cy=h/2;
      const colors=[[255,212,77],[0,255,169],[61,183,255],[255,255,255]];
      const N=Math.floor(Math.min(80,50+(w*h)/60000)); const parts=[];
      for(let i=0;i<N;i++){
        const ang=Math.random()*Math.PI*2, sp=(80+Math.random()*180)*dpr, r=(1.3+Math.random()*2)*dpr, col=colors[(Math.random()*colors.length)|0];
        parts.push({x:cx,y:cy,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:0,max:0.7+Math.random()*0.4,r,col});
      }
      ctx.globalCompositeOperation='lighter';
      await animateMs(duration,(p,dt)=>{
        ctx.clearRect(0,0,w,h);
        const ringR=(Math.max(w,h)*0.46)*Math.sin(p*Math.PI); const aR=(1-p)*0.85;
        ctx.lineWidth=Math.max(1,4.5*dpr*(1-p)); ctx.strokeStyle=rgba(255,212,77,aR); ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,ringR*0.6),0,Math.PI*2); ctx.stroke();
        ctx.strokeStyle=rgba(0,212,106,aR*0.85); ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,ringR*0.42),0,Math.PI*2); ctx.stroke();
        for(const pt of parts){
          pt.life+=dt; pt.vx*=(1-0.8*dt); pt.vy*=(1-0.8*dt); pt.vy+=240*dt*dpr*0.25; pt.x+=pt.vx*dt; pt.y+=pt.vy*dt;
          const a=Math.max(0,1-(pt.life/pt.max)); if(a<=0) continue;
          ctx.beginPath(); ctx.fillStyle=rgba(pt.col[0],pt.col[1],pt.col[2],a); ctx.arc(pt.x,pt.y,pt.r,0,Math.PI*2); ctx.fill();
        }
      });
      cleanup();
    })(placeholder, 1000);

    const st=ALL[chosen]||'ocupado'; SEARCH_INPUT.value=String(parseInt(chosen,10));
    layer.innerHTML='';
    if(st==='libre'){ renderSearchOne(chosen); } else { clearSearchLayer(); msg('Boleta ocupada', true); }
    randomBtn.dataset.busy='';
  },{passive:true});

  // Botón FINALIZAR (superior)
  const finishTopBtn = document.getElementById('finishTop');
  if(finishTopBtn){
    finishTopBtn.addEventListener('click',(e)=>{
      e.preventDefault();
      finalizeCart();
    });
  }

  // ARRANQUE EXPRESS (con boot)
  bootSet(60, 'Cargando boletas…', 'Usando caché para abrir ultra rápido');
  DAY_MARK=todayKey();

  const mcache=loadMapCache();
  if(mcache?.freeList){
    setAllFromFreeList(mcache.freeList);
    pickDaily(true);
    renderGrid();
    bootSet(82, 'Sincronizando disponibilidad…', 'Actualizando datos en segundo plano');
    if(mcache.stale){ (window.requestIdleCallback? requestIdleCallback(syncMapFast): setTimeout(syncMapFast,0)); }
    else setTimeout(syncMapFast, 1500);
  }else{
    const wrap=document.getElementById('raffles');
    const frag=document.createDocumentFragment();
    for(let i=0;i<24;i++){ const s=document.createElement('div'); s.className='raffle'; s.innerHTML='<span>----</span>'; frag.appendChild(s); }
    wrap.appendChild(frag);
    bootSet(72, 'Descargando disponibilidad…', 'Primera carga (solo esta vez)');
    await syncMapFast();
    pickDaily(true);
    renderGrid();
  }

  bootSet(95, 'Finalizando…', 'Todo listo');
  setTimeout(()=> bootHide(), 220);

  // Refrescos suaves
  GRID_TIMER=setInterval(()=>renderGrid(), 20000);
  MAP_TIMER=setInterval(async ()=>{
    const nowKey=todayKey();
    if(nowKey!==DAY_MARK){ DAY_MARK=nowKey; await syncMapFast(); DAILY=[]; pickDaily(true); renderGrid(); return; }
    const before=DAILY.length; await syncMapFast(); if(DAILY.length!==before){ renderGrid(); }
  }, 20000);
});
  </script>
</body>
</html>
